# Система аудита действий пользователей

## Описание

Система аудита обеспечивает автоматическое логирование всех действий авторизованных пользователей в системе управления рейтингом петанка. Каждое изменение данных фиксируется с детальной информацией о пользователе, времени, типе операции и затронутых сущностях.

## Возможности

### 1. Автоматическое логирование

Система автоматически записывает следующие типы действий:

- **Аутентификация**:

  - Успешный вход в систему
  - Неудачные попытки входа

- **Управление пользователями** (только для ADMIN):

  - Создание пользователей
  - Редактирование пользователей
  - Удаление пользователей

- **Управление турнирами**:

  - Загрузка результатов турниров (Excel / Google Sheets)
  - Редактирование информации о турнире
  - Удаление турниров

- **Управление игроками**:

  - Создание игроков
  - Редактирование игроков
  - Удаление игроков
  - Массовая загрузка игроков

- **Управление лицензированными игроками**:

  - Создание записей о лицензиях
  - Редактирование лицензий
  - Удаление лицензий
  - Загрузка списка лицензий

- **Управление настройками** (только для ADMIN):
  - Изменение параметров системы

### 2. Сохраняемая информация

Для каждого действия записывается:

- **Основная информация**:

  - ID и имя пользователя
  - Роль пользователя на момент действия
  - Тип действия (CREATE, UPDATE, DELETE, LOGIN и т.д.)
  - Дата и время действия

- **Информация о сущности**:

  - Тип сущности (tournament, player, user и т.д.)
  - ID сущности
  - Название сущности

- **Технические детали**:

  - IP-адрес
  - User Agent (браузер)
  - HTTP метод (GET, POST, PUT, DELETE)
  - URL запроса
  - Тело запроса (без паролей и чувствительных данных)

- **Результат операции**:
  - Статус успешности
  - Сообщение об ошибке (если была ошибка)
  - Изменения (старые и новые значения для операций обновления)

### 3. Веб-интерфейс для просмотра логов

Доступен только для администраторов (роль ADMIN) по адресу `/admin/audit-logs`.

#### Фильтрация логов:

- По пользователю
- По типу действия
- По типу сущности
- По статусу (успешно/ошибка)
- По диапазону дат

#### Просмотр деталей:

- Полная информация о каждом действии
- Просмотр изменений (до/после)
- Технические детали запроса

#### Статистика:

- Общее количество действий
- Количество успешных и неудачных операций
- Распределение по типам действий
- Активность пользователей
- Распределение по типам сущностей

## Структура базы данных

### Таблица `audit_logs`

```sql
CREATE TABLE audit_logs (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  username VARCHAR(100) NOT NULL,
  user_role ENUM('ADMIN', 'MANAGER') NOT NULL,
  action VARCHAR(100) NOT NULL,
  entity_type VARCHAR(50) NULL,
  entity_id INT NULL,
  entity_name VARCHAR(255) NULL,
  description TEXT NULL,
  ip_address VARCHAR(45) NULL,
  user_agent TEXT NULL,
  request_method VARCHAR(10) NULL,
  request_url VARCHAR(500) NULL,
  request_body JSON NULL,
  changes JSON NULL,
  success BOOLEAN DEFAULT TRUE,
  error_message TEXT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  -- Индексы для быстрого поиска
  INDEX idx_user_id (user_id),
  INDEX idx_username (username),
  INDEX idx_action (action),
  INDEX idx_entity (entity_type, entity_id),
  INDEX idx_created_at (created_at DESC),
  INDEX idx_success (success),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT
);
```

## API endpoints

### Получить логи с фильтрацией

```
GET /api/admin/audit-logs?username=...&action=...&date_from=...&date_to=...&limit=50&offset=0
```

### Получить конкретный лог

```
GET /api/admin/audit-logs/:id
```

### Получить историю действий пользователя

```
GET /api/admin/audit-logs/user/:userId?limit=50
```

### Получить историю изменений сущности

```
GET /api/admin/audit-logs/entity/:entityType/:entityId?limit=50
```

### Получить статистику

```
GET /api/admin/audit-logs/statistics?date_from=...&date_to=...
```

### Получить список действий

```
GET /api/admin/audit-logs/actions
```

### Получить список типов сущностей

```
GET /api/admin/audit-logs/entity-types
```

### Очистить старые записи (только ADMIN)

```
DELETE /api/admin/audit-logs/cleanup
Body: { "days": 365 }
```

## Типы действий

- `LOGIN` - Вход в систему
- `CREATE_TOURNAMENT` - Создание турнира
- `UPDATE_TOURNAMENT` - Редактирование турнира
- `DELETE_TOURNAMENT` - Удаление турнира
- `UPLOAD_TOURNAMENT` - Загрузка результатов турнира
- `CREATE_PLAYER` - Создание игрока
- `UPDATE_PLAYER` - Редактирование игрока
- `DELETE_PLAYER` - Удаление игрока
- `MERGE_PLAYERS` - Слияние игроков
- `CREATE_USER` - Создание пользователя
- `UPDATE_USER` - Редактирование пользователя
- `DELETE_USER` - Удаление пользователя
- `UPDATE_SETTINGS` - Изменение настроек
- `UPLOAD_LICENSED_PLAYERS` - Загрузка лицензированных игроков

## Типы сущностей

- `tournament` - Турнир
- `player` - Игрок
- `team` - Команда
- `user` - Пользователь
- `settings` - Настройки
- `licensed_player` - Лицензированный игрок

## Безопасность

1. **Фильтрация чувствительных данных**: Пароли и другие чувствительные данные автоматически удаляются из логов запросов.

2. **Доступ только для администраторов**: Просмотр логов доступен только пользователям с ролью ADMIN.

3. **Ограничение на удаление**: Невозможно удалить записи моложе 30 дней.

4. **FOREIGN KEY с RESTRICT**: Удаление пользователя блокируется, если у него есть записи в логах.

## Производительность

1. **Индексы**: Созданы индексы для всех часто используемых полей поиска.

2. **Асинхронное логирование**: Запись логов не блокирует основные операции.

3. **Обработка ошибок**: Ошибки при создании логов не прерывают основную операцию.

4. **Пагинация**: Все запросы к логам используют пагинацию для оптимальной производительности.

## Миграция

Для применения изменений в существующей базе данных выполните:

```bash
npm run check-db
```

Миграция `007_add_audit_logs.ts` автоматически создаст таблицу `audit_logs`.

## Интеграция в новые роуты

Для добавления логирования в новый роут используйте middleware:

```typescript
import { auditLog } from "../middleware/audit";

router.post(
  "/endpoint",
  authenticateAdmin,
  auditLog({
    action: "ACTION_NAME",
    entityType: "entity_type",
    getEntityId: (req) => parseInt(req.params.id),
    getEntityName: (req) => req.body.name,
    getDescription: (req) => `Описание действия`,
  }),
  Controller.method
);
```

## Очистка старых логов

Для автоматической очистки старых логов можно настроить cron-задачу:

```bash
# Удалять логи старше 1 года каждую ночь в 3:00
0 3 * * * curl -X DELETE http://localhost:3001/api/admin/audit-logs/cleanup \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"days": 365}'
```

## Рекомендации

1. **Регулярная очистка**: Удаляйте старые записи (старше 1-2 лет) для оптимизации производительности.

2. **Мониторинг**: Периодически проверяйте логи на наличие подозрительной активности.

3. **Резервное копирование**: Включайте таблицу `audit_logs` в регулярные бэкапы.

4. **Анализ статистики**: Используйте статистику для выявления паттернов использования системы.
