# Архив миграций базы данных

Данный документ содержит информацию о миграциях, которые были объединены в единый файл инициализации базы данных.

## Обзор

Все миграции были объединены в два файла:

- `/init-database.sql` - полный SQL файл для новых инсталляций
- `/mysql/init/01-init.sql` - обновленный инициализационный файл для Docker

## Список объединенных миграций

### 1. migrate.ts - Основная миграция

**Описание:** Создание основных таблиц системы

- `players` - таблица игроков
- `tournaments` - таблица турниров
- `tournament_results` - результаты турниров (исходная версия)
- `rating_settings` - настройки рейтинга
- `admins` - администраторы
- `licensed_players` - лицензионные игроки

### 2. add-gender-column.ts - Добавление пола игроков

**Описание:** Добавление поля `gender` в таблицу `players`

- Добавлен столбец `gender ENUM('male', 'female')`
- Создан индекс для поиска по полу

### 3. add-teams.ts - Система команд (первая версия)

**Описание:** Создание системы команд с таблицами

- `teams` - команды с привязкой к турнирам
- `team_members` - участники команд
- Миграция данных из player-based в team-based структуру

### 4. add-wins-column.ts - Добавление побед

**Описание:** Добавление поля количества побед

- Добавлен столбец `wins` в `tournament_results`

### 5. rename-cup-position-to-points-reason.ts - Переименование поля

**Описание:** Переименование `cup_position` в `cup_position`

- Создан enum с типами результатов турнира
- Конвертация существующих данных

### 6. remove-position-enum-duplicates.ts - Очистка enum

**Описание:** Удаление дублирующихся значений в enum

- Обновление записей POSITION*\* на CUP*\*
- Очистка enum от устаревших значений

### 7. rename-wins-to-qualifying-wins.ts - Переименование побед

**Описание:** Переименование `wins` в `qualifying_wins`

- Уточнение назначения поля

### 8. add-wins-loses-columns.ts - Добавление побед и поражений

**Описание:** Добавление полей статистики

- Добавлены столбцы `wins` и `loses`
- Автоматический расчет значений

### 9. create-player-tournament-points.ts - Рейтинговые очки

**Описание:** Создание таблицы рейтинговых очков игроков

- Таблица `player_tournament_points`
- Миграция очков из tournament_results

### 10. remove-points-from-tournament-results.ts - Удаление очков

**Описание:** Удаление поля `points` из `tournament_results`

- Очки теперь хранятся в отдельной таблице

### 11. remove-tournament-from-teams.ts - Глобальные команды

**Описание:** Удаление привязки команд к турнирам

- Команды стали глобальными (без tournament_id)
- Уникальность по составу игроков

### 12. restructure-teams-final.ts - Финальная структура команд

**Описание:** Окончательная структура команд

- Таблица `team_players` для связи команд и игроков
- Удаление прямых полей player1_id, player2_id и т.д.

### 13. populate-gender.ts - Заполнение пола

**Описание:** Автоматическое определение пола игроков

- **ВАЖНО:** Требует выполнения через приложение
- Использует алгоритм распознавания имен

### 14. update-gender.ts - Обновление определения пола

**Описание:** Повторное определение пола с улучшенным алгоритмом

- **ВАЖНО:** Требует выполнения через приложение
- Обновляет существующие определения

### 15. link-licensed-players.ts - Связывание лицензионных игроков

**Описание:** Связывание таблиц licensed_players и players через внешний ключ

- Убирает поле `full_name` из `licensed_players`
- Добавляет поле `player_id` для связи с `players`
- Создает игроков в таблице `players` для всех лицензированных
- Устанавливает связи и ограничения целостности
- **ВАЖНО:** Требует выполнения через приложение

### 16. Вспомогательные миграции

- `fix-cup-position.ts` - Исправление структуры cup_position
- `restructure-teams.ts` - Промежуточные изменения в командах
- `restructure-teams-simple.ts` - Упрощенная структура команд

## Финальная структура базы данных

### Основные таблицы:

1. **players** - игроки с полом
2. **tournaments** - турниры
3. **teams** - глобальные команды (до 4 игроков)
4. **team_players** - связь команд и игроков
5. **tournament_results** - результаты (без очков, с причиной очков)
6. **player_tournament_points** - рейтинговые очки игроков

### Административные таблицы:

1. **rating_settings** - настройки системы
2. **admins** - администраторы
3. **licensed_players** - лицензионные игроки (связаны с players через player_id)

## Особенности миграции

### Автоматические операции:

✅ Создание всех таблиц  
✅ Настройка индексов  
✅ Установка внешних ключей  
✅ Базовые настройки системы

### Требуют выполнения через приложение:

⚠️ **populate-gender.ts** - определение пола существующих игроков  
⚠️ **update-gender.ts** - обновление определения пола  
⚠️ **link-licensed-players.ts** - связывание лицензионных игроков с основной таблицей

### Миграция существующих данных:

При переходе со старой структуры на новую может потребоваться:

1. Миграция команд из старого формата в новый
2. Пересчет рейтинговых очков
3. Определение пола для существующих игроков

## Использование

### Новая установка:

```sql
-- Выполните init-database.sql или перезапустите Docker контейнеры
```

### Обновление существующей БД:

1. Создайте резервную копию
2. Выполните миграции через приложение:
   ```bash
   cd backend
   npm run migrate
   ```

## Проверка

После инициализации проверьте:

```sql
-- Проверка структуры таблиц
SHOW TABLES;
DESCRIBE players;
DESCRIBE teams;
DESCRIBE tournament_results;
DESCRIBE player_tournament_points;

-- Проверка настроек
SELECT * FROM rating_settings;
```

## Восстановление

Если необходимо восстановить отдельные миграции, они сохранены в папке:
`/backend/src/migrations/`

Каждая миграция может быть выполнена отдельно через TypeScript код.
