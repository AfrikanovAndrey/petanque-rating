#!/bin/bash

# ========================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
# ========================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MIGRATIONS_DIR="$SCRIPT_DIR/backend/src/migrations"
ARCHIVE_DIR="$SCRIPT_DIR/migrations-archive"
DATE=$(date +"%Y%m%d_%H%M%S")

echo "üóÇÔ∏è –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
echo "üìÅ –ò—Å—Ç–æ—á–Ω–∏–∫: $MIGRATIONS_DIR"
echo "üìÅ –ê—Ä—Ö–∏–≤: $ARCHIVE_DIR"

# –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –∞—Ä—Ö–∏–≤–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "$ARCHIVE_DIR"

# –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞
CURRENT_ARCHIVE="$ARCHIVE_DIR/migrations_$DATE"
mkdir -p "$CURRENT_ARCHIVE"

# –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üìÑ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π..."
cp -r "$MIGRATIONS_DIR"/* "$CURRENT_ARCHIVE/"

# –°–æ–∑–¥–∞—Ç—å README –¥–ª—è –∞—Ä—Ö–∏–≤–∞
cat > "$CURRENT_ARCHIVE/README.md" << EOF
# –ê—Ä—Ö–∏–≤ –º–∏–≥—Ä–∞—Ü–∏–π –æ—Ç $DATE

–≠—Ç–æ—Ç –∞—Ä—Ö–∏–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ –µ–¥–∏–Ω—ã–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π —Ñ–∞–π–ª.

## –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞

$(ls -la "$CURRENT_ARCHIVE"/*.ts 2>/dev/null | awk '{print "- " $9}' | sed 's|.*/||')

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

–î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω—É–∂–Ω—ã–π —Ñ–∞–π–ª –æ–±—Ä–∞—Ç–Ω–æ –≤ \`backend/src/migrations/\`
2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –≤ \`migrate.ts\`
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:
   \`\`\`bash
   cd backend
   npm run migrate
   \`\`\`

## –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π

–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –º–∏–≥—Ä–∞—Ü–∏–π:

\`\`\`bash
cp migrations_$DATE/* ../backend/src/migrations/
\`\`\`

## –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ë–î

\`\`\`bash
# –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
docker exec petanque-mysql mysqldump -u root -p petanque_rating > backup_$DATE.sql

# –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
docker exec -i petanque-mysql mysql -u root -p petanque_rating < backup_$DATE.sql
\`\`\`
EOF

echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $CURRENT_ARCHIVE"

# –°–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞—Ä—Ö–∏–≤
ln -sfn "migrations_$DATE" "$ARCHIVE_DIR/latest"

echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
echo "   üìÑ –§–∞–π–ª–æ–≤ –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ: $(ls -1 "$CURRENT_ARCHIVE"/*.ts 2>/dev/null | wc -l)"
echo "   üì¶ –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: $(du -sh "$CURRENT_ARCHIVE" | cut -f1)"
echo "   üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞—Ä—Ö–∏–≤: $ARCHIVE_DIR/latest"

# –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
cat << EOF

üìã –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

1. ‚úÖ –ê—Ä—Ö–∏–≤ –º–∏–≥—Ä–∞—Ü–∏–π —Å–æ–∑–¥–∞–Ω
2. üîÑ –û–±–Ω–æ–≤–∏—Ç–µ backend/src/migrations/migrate.ts:
   - –£–±–µ—Ä–∏—Ç–µ –∏–º–ø–æ—Ä—Ç—ã –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
   - –û—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
   
3. üê≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î:
   docker-compose down
   docker-compose up -d

4. üß™ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ñ–∞–π–ª–µ: –ú–ò–ì–†–ê–¶–ò–ò_–ê–†–•–ò–í.md

EOF

echo "üéâ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
